version: 2.1
jobs:
  build-and-deploy:
    docker:
      - image: google/cloud-sdk
    steps:
      - checkout
      - node/install:
          install-yarn: false
          node-version: latest
      - run: |
          echo $GCLOUD_SERVICE_KEY_DEPLOY | gcloud auth activate-service-account --key-file=-
          gcloud --quiet config set project ${GOOGLE_PROJECT_ID}
          gcloud --quiet config set compute/zone ${GOOGLE_COMPUTE_ZONE}
      - run: 
          name: build back end
          command: cd cookbook-api && npm install && npm run tsc && cp -R database/migrations/scripts .built/database/migrations
      - run: 
          name: build front end
          command: cd cookbook-front-end && npm install && npm run build && cp -r build ../cookbook-api/.built
      - run: 
          name: create app.yaml
          command: cd cookbook-api && npm run app-yaml
      - deploy:
          name: deploy app
          command: cd cookbook-api && gcloud app deploy && gcloud app versions delete `gcloud app versions list | sed 's/  */:/g' | cut -f 2 -d : | tail -n +2 | head -n -5 | tr "\n" " "`

orbs:
  node: circleci/node@2.1.1         
workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build-and-deploy:
          filters:
            branches:
              only: master

